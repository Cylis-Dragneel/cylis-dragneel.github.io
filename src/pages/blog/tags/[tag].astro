---
import MainLayout from "../../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];
  
  return uniqueTags.map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

interface Props {
  tag: string;
}

const { tag } = Astro.props;

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const posts = allPosts
  .filter((post) => post.data.tags.includes(tag))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<MainLayout title={`${tag} | Cylis Blog`} currentPage="Blog">
  <section class="blog-list py-24">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <a href="/blog" class="blog-reset-filter inline-flex items-center gap-2 text-sm mb-6 hover:text-accent-400 transition-colors">
        <span>←</span>
        <span>Reset filters</span>
      </a>

      <h1 class="text-4xl font-bold blog-heading mb-2">
        <span class="text-accent-400">#</span>{tag}
      </h1>
      <div class="w-20 h-1 bg-accent-500 mb-6"></div>
      <p class="blog-description text-lg mb-12">
        {posts.length} {posts.length === 1 ? "post" : "posts"} tagged with "{tag}"
      </p>

      {
        posts.length === 0 ? (
          <div class="text-center py-12">
            <p class="blog-empty">No posts with this tag yet.</p>
          </div>
        ) : (
          <div class="space-y-8">
            {posts.map((post) => (
              <article class="group">
                <div
                  class="blog-card block p-6 rounded-xl border transition-all hover:-translate-y-1 relative overflow-hidden"
                >
                  {post.data.banner && (
                    <a
                      href={`/blog/${post.slug}`}
                      class="blog-card-banner absolute right-0 top-0 bottom-0 w-32 sm:w-48 shrink-0"
                    >
                      <img
                        src={`/blog/img/${post.data.banner}`}
                        alt=""
                        class="w-full h-full object-cover"
                      />
                      <div class="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-[var(--theme-bg-secondary)] to-transparent"></div>
                    </a>
                  )}
                  <div class="relative z-10 pr-4 max-w-[calc(100%-8rem)] sm:max-w-[calc(100%-12rem)]">
                    <div class="flex flex-wrap gap-2 mb-3">
                      {post.data.tags.map((t) => (
                        <a
                          href={`/blog/tags/${t}`}
                          class="blog-tag inline-block px-2 py-1 text-xs font-mono rounded hover:text-accent-400 transition-colors"
                        >
                          {t}
                        </a>
                      ))}
                    </div>

                    <h2 class="text-xl font-semibold blog-card-title group-hover:text-accent-400 transition-colors mb-2">
                      <a href={`/blog/${post.slug}`} class="hover:text-accent-400 transition-colors">
                        {post.data.title}
                      </a>
                    </h2>

                    <p class="blog-card-summary text-sm mb-4 line-clamp-2">
                      {post.data.summary}
                    </p>

                    <div class="flex items-center gap-4 text-sm blog-card-meta">
                      <span>{formatDate(post.data.date)}</span>
                      <span>·</span>
                      <span>by {post.data.author}</span>
                    </div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        )
      }
    </div>
  </section>
</MainLayout>

<style>
  .blog-list {
    background-color: var(--theme-bg);
  }

  .blog-reset-filter {
    color: var(--theme-text-muted);
  }

  .blog-heading {
    color: var(--theme-text);
  }

  .blog-description {
    color: var(--theme-text-muted);
  }

  .blog-empty {
    color: var(--theme-text-muted);
  }

  .blog-card {
    background-color: var(--theme-bg-secondary);
    border-color: var(--theme-border);
  }

  .blog-card:hover {
    border-color: var(--theme-accent);
  }

  .blog-tag {
    color: var(--theme-accent);
    background-color: color-mix(in srgb, var(--theme-accent) 15%, transparent);
  }

  .blog-card-title {
    color: var(--theme-text);
  }

  .blog-card-summary {
    color: var(--theme-text-secondary);
  }

  .blog-card-meta {
    color: var(--theme-text-muted);
  }
</style>
